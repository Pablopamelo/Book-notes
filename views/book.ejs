<%- include("partials/header.ejs") %>

    <link href = "/styles/book.css" rel = "stylesheet">

    <div id = "mainCont">
        <main>
            <div class = "floatingCont">
                <div class = "left">

                    <div id = "back"><a href = "/">Back</a></div>

                    <div class = "book">
                        <div class = "top">
                            <div class= "cover">
                                <img class = "coverImg" src = "<%= book.cover %>">
                            </div>
                        </div>

                        <div class = "bottom">
                            <div id = "title">
                                <%= book.title %>
                            </div>

                            <div id = "author">
                                <%= book.author %>
                            </div>

                            <div id = "rating">
                                <%= "*".repeat(book.rating); %>
                            </div>
                        </div>
                    </div>
                </div>

                <div class = "right">
                    <div id = "bookNotes">

                        <div class = "note">
                            <form method = "POST" action = "/noteAdd/<%= book.id %>">
                                <div class = "formCont">
                                    <textarea name = "title" id = "noteTitleAdd" placeholder = "title"></textarea>

                                    <textarea name = "content" id = "noteContentAdd" placeholder = "content"></textarea>

                                    <button type = "submit">add</button>
                                </div>
                            </form>
                        </div>

                        <% if(locals.notes){ %>
                            <% notes.forEach((note) => { %>
                                <div class = "note" id = "note<%= note.id %>">
                                    <form method = "POST">
                                        <div class = "formCont">
                                            <div class = "noteTitle" id = "noteTitle<%= note.id %>"><%= note.notetitle %></div>
                                            <input id = "noteTitle_edit<%= note.id %>" hidden>

                                            <div class = "noteContent" id = "noteContent<%= note.id %>"><%= note.notecontent %></div>
                                            <input id = "noteContent_edit<%= note.id %>" hidden>

                                            <div id = "noteDate<%= note.id %>" class = "noteDate"><%= note.note_date %></div>

                                            <div class = "buttons">
                                                <button type = "button" onclick = "Show('<%= note.id %>')" class = "noteEdit"  id = "noteEdit<%= note.id %>">edit</button>
                                                <button type = "button" onclick = "Edit('<%= note.id %>')" class = "submitNoteEdit" id = "submitNoteEdit<%= note.id %>" hidden>confirm</button>

                                                <button type = "submit" formaction = "/noteDelete/<%= book.id %>/<%= note.id %>" class = "noteDelete">delete</button>
                                            </div>

                                        </div>
                                    </form>
                                </div>
                           <% }); %>
                        <% } %>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const textarea1 = document.getElementById("noteTitleAdd"); 
        const textarea2 = document.getElementById("noteContentAdd"); 

        textarea1.addEventListener("input", async () => {
            checkScroll();
        });

        textarea2.addEventListener("input", async () => {
            checkScroll();
        });

        function checkScroll(){
            textarea1.style.height = "2.6rem";
            textarea2.style.height = "1.75rem";
            if (textarea1.scrollHeight > textarea1.clientHeight) {
                textarea1.style.height = textarea1.scrollHeight + "px";
            }
            if (textarea2.scrollHeight > textarea2.clientHeight) {
                textarea2.style.height = textarea2.scrollHeight + "px";
            }
        }

        function Show(id_string){
            event.preventDefault();
            const id = parseInt(id_string);
            document.getElementById(`noteEdit${id}`).hidden = true;
            document.getElementById(`noteTitle${id}`).hidden = true;
            document.getElementById(`noteContent${id}`).hidden = true;

            document.getElementById(`noteContent_edit${id}`).hidden = false;
            document.getElementById(`noteTitle_edit${id}`).hidden = false;
            document.getElementById(`submitNoteEdit${id}`).hidden = false;
        }

        async function Edit(id_string){
            const id = parseInt(id_string);
            const title = document.getElementById(`noteTitle_edit${id}`).value;
            const content = document.getElementById(`noteContent_edit${id}`).value;

            try{
                const response = await axios.patch(`/noteEdit/${id}`,
                {
                    title: title,
                    content: content
                });

                const newTitle = response.data.title;
                const newContent = response.data.content;
                const newDate = response.data.date;

                document.getElementById(`noteEdit${id}`).hidden = false;
                document.getElementById(`noteTitle${id}`).hidden = false;
                document.getElementById(`noteContent${id}`).hidden = false;

                document.getElementById(`submitNoteEdit${id}`).hidden = true;
                document.getElementById(`noteContent_edit${id}`).hidden = true;
                document.getElementById(`noteTitle_edit${id}`).hidden = true;

                document.getElementById(`noteTitle${id}`).innerText = newTitle;
                document.getElementById(`noteContent${id}`).innerText = newContent;
                document.getElementById(`noteDate${id}`).innerText = newDate;

            }catch(error){  
                console.log(error);
            }
        }
    </script>


<%- include("partials/footer.ejs") %>